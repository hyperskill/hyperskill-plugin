package org.hyperskill.academy.jvm

import com.intellij.openapi.application.runWriteAction
import com.intellij.openapi.diagnostic.logger
import com.intellij.openapi.options.ConfigurationException
import com.intellij.openapi.project.Project
import com.intellij.openapi.project.ProjectManager
import com.intellij.openapi.projectRoots.JavaSdk
import com.intellij.openapi.projectRoots.ProjectJdkTable
import com.intellij.openapi.projectRoots.Sdk
import com.intellij.openapi.projectRoots.SdkModificator
import com.intellij.openapi.projectRoots.impl.JavaSdkImpl
import com.intellij.openapi.projectRoots.impl.SdkConfigurationUtil
import com.intellij.openapi.roots.LanguageLevelProjectExtension
import com.intellij.openapi.roots.ProjectRootManager
import com.intellij.openapi.roots.ui.configuration.ProjectStructureConfigurable
import com.intellij.openapi.roots.ui.configuration.projectRoot.ProjectSdksModel
import com.intellij.openapi.vfs.LocalFileSystem
import org.hyperskill.academy.learning.*
import org.hyperskill.academy.learning.DefaultSettingsUtils.findPath
import org.hyperskill.academy.learning.DefaultSettingsUtils.propertyValue
import org.hyperskill.academy.learning.courseFormat.Course
import org.hyperskill.academy.learning.newproject.EduProjectSettings

open class JdkProjectSettings(val model: ProjectSdksModel, val jdk: Sdk?) : EduProjectSettings {

  fun setUpProjectJdk(
    project: Project,
    course: Course,
    getJdk: JdkProjectSettings.() -> Sdk? = { jdk }
  ): Sdk? {
    val jdk = getJdk()

    // Only apply the model if the selected JDK is NOT already in ProjectJdkTable.
    // When using ProjectSdksModel from ProjectStructureConfigurable (e.g., from JdkLanguageSettings),
    // the model already contains existing SDKs. Calling apply() would try to add them again,
    // causing SymbolicIdAlreadyExistsException in IntelliJ 2025.3+.
    val jdkExistsInTable = jdk != null && ProjectJdkTable.getInstance().findJdk(jdk.name) != null
    if (!jdkExistsInTable) {
      try {
        model.apply()
      }
      catch (e: ConfigurationException) {
        LOG.error(e)
      }
      catch (e: RuntimeException) {
        // SymbolicIdAlreadyExistsException may still occur in edge cases
        LOG.warn("Failed to apply SDK model: ${e.message}")
      }
    }

    runWriteAction {
      ProjectRootManager.getInstance(project).projectSdk = jdk
      addAnnotations(ProjectRootManager.getInstance(project).projectSdk?.sdkModificator)
      val sdkVersion = course.minJvmSdkVersion
      if (sdkVersion is JavaVersionParseSuccess) {
        LanguageLevelProjectExtension.getInstance(project).languageLevel = sdkVersion.javaSdkVersion.maxLanguageLevel
      }
    }
    return jdk
  }

  private fun addAnnotations(sdkModificator: SdkModificator?) {
    sdkModificator?.apply {
      JavaSdkImpl.attachJdkAnnotations(this)
      commitChanges()
    }
  }

  companion object {

    private val LOG = logger<JdkProjectSettings>()

    private const val DEFAULT_JDK_PROPERTY: String = "project.jdk"
    private const val DEFAULT_JDK_NAME_PROPERTY: String = "project.jdk.name"

    private const val DEFAULT_JDK_NAME: String = "jdk"

    fun emptySettings(): JdkProjectSettings {
      val configurable = ProjectStructureConfigurable.getInstance(ProjectManager.getInstance().defaultProject)
      return JdkProjectSettings(configurable.projectJdksModel, null)
    }

    fun defaultSettings(): Result<JdkProjectSettings, String> {
      // Use `EnvironmentService` instead to get default JDK path and name
      return findPath(DEFAULT_JDK_PROPERTY, "jdk").flatMap { jdkPath ->
        val jdkName = propertyValue(DEFAULT_JDK_NAME_PROPERTY, "JDK name").onError { DEFAULT_JDK_NAME }

        var jdk = ProjectJdkTable.getInstance().findJdk(jdkName)
        val jdkAlreadyExists = jdk != null

        if (jdk == null) {
          val jdkHomeDir = LocalFileSystem.getInstance().refreshAndFindFileByPath(jdkPath)
          if (jdkHomeDir == null) {
            return@flatMap Err("$jdkPath doesn't exist")
          }
          jdk = SdkConfigurationUtil.setupSdk(arrayOfNulls(0), jdkHomeDir, JavaSdk.getInstance(), true, null, jdkName)
          if (jdk == null) {
            return@flatMap Err("Failed to create JDK for $jdkPath")
          }
        }

        val sdksModel = ProjectSdksModel()
        // Only add SDK to model if it doesn't already exist in ProjectJdkTable
        // to avoid SymbolicIdAlreadyExistsException when model.apply() is called
        if (!jdkAlreadyExists) {
          sdksModel.addSdk(jdk)
        }

        Ok(JdkProjectSettings(sdksModel, jdk))
      }
    }
  }
}
